@startuml Detailed CRUD Operations - Sequence Diagram

!theme plain
skinparam backgroundColor white
skinparam sequenceArrowThickness 2
skinparam roundcorner 15
skinparam maxmessagesize 70

actor User as "ğŸ‘¤ NgÆ°á»i dÃ¹ng"
participant GUI as "ğŸ–¥ï¸ KhoGUI\n<<View Layer>>"
participant Controller as "ğŸ® HangHoaController\n<<Business Logic>>"
participant DAO as "ğŸ—ƒï¸ HangHoaDAO\n<<Data Access Layer>>"
participant Product as "ğŸ“¦ HangHoa\n<<Abstract Entity>>"
participant Food as "ğŸ¥— ThucPham\n<<Concrete Entity>>"
participant Electric as "âš¡ DienMay\n<<Concrete Entity>>"
participant Ceramic as "ğŸº SanhSu\n<<Concrete Entity>>"
participant DB as "ğŸ”— DatabaseConnection\n<<Singleton>>"
database MySQL as "ğŸ—„ï¸ MySQL Database\n<<QuanLyKhoHang>>"

title ğŸª Há»‡ thá»‘ng Quáº£n lÃ½ Kho - Chi tiáº¿t thao tÃ¡c CRUD (MVC Pattern)

== 1ï¸âƒ£ USE CASE: ThÃªm Thá»±c pháº©m má»›i ==

User -> GUI: 1. Nháº­p thÃ´ng tin thá»±c pháº©m
activate GUI
note right: MÃ£ hÃ ng, tÃªn, sá»‘ lÆ°á»£ng,\nÄ‘Æ¡n giÃ¡, ngÃ y SX, ngÃ y HH,\nnhÃ  cung cáº¥p

User -> GUI: 2. Click "â• ThÃªm" button
GUI -> GUI: 3. Validate input data (basic)
alt Dá»¯ liá»‡u há»£p lá»‡
    GUI -> Controller: 4. themThucPham(maHang, tenHang, soLuong,\n                     donGia, ngaySX, ngayHH, nhaCungCap)
    activate Controller
    
    Controller -> Controller: 5. Validate business rules
    note right: - validateMaHang()\n- validateTenHang()\n- Kiá»ƒm tra sá»‘ lÆ°á»£ng >= 0\n- Kiá»ƒm tra Ä‘Æ¡n giÃ¡ > 0\n- Parse & validate dates\n- Kiá»ƒm tra mÃ£ hÃ ng tá»“n táº¡i
    
    alt Validation thÃ nh cÃ´ng
        Controller -> Food: 6. new ThucPham(maHang, tenHang, soLuong,\n                     donGia, ngaySX, ngayHH, nhaCungCap)
        activate Food
        
        Food -> Food: 7. Validate entity rules
        note right: - Kiá»ƒm tra ngÃ y háº¿t háº¡n > ngÃ y SX\n- TÃ­nh toÃ¡n VAT = 5%\n- Set business properties
        
        Food --> Controller: 8. ThucPham object created
        deactivate Food
        
        Controller -> DAO: 9. themThucPham(thucPham)
        activate DAO
        
        DAO -> DB: 10. getConnection()
        activate DB
        DB -> MySQL: 11. Establish connection
        activate MySQL
        MySQL --> DB: 12. Connection ready
        DB --> DAO: 13. Connection object
        deactivate DB
        
        DAO -> MySQL: 14. BEGIN TRANSACTION
        DAO -> MySQL: 15. INSERT INTO HangHoa\n       (MaHang, TenHang, LoaiHang, SoLuongTon, DonGia, VAT)\n       VALUES (?, ?, 'ThucPham', ?, ?, 0.05)
        DAO -> MySQL: 16. INSERT INTO ThucPham\n       (MaHang, NgaySanXuat, NgayHetHan, NhaCungCap)\n       VALUES (?, ?, ?, ?)
        DAO -> MySQL: 17. COMMIT
        
        alt Database operation thÃ nh cÃ´ng
            MySQL --> DAO: 18a. Transaction successful
            DAO --> Controller: 19a. true (success)
        else Database operation tháº¥t báº¡i
            MySQL --> DAO: 18b. ERROR
            DAO -> MySQL: ROLLBACK
            DAO --> Controller: 19b. false (failed)
        end
        
        deactivate MySQL
        deactivate DAO
        
        Controller --> GUI: 20. boolean result
        deactivate Controller
        
        alt ThÃªm thÃ nh cÃ´ng
            GUI -> GUI: 21. loadData() - Refresh table
            GUI -> Controller: 22. layDanhSachHangHoa()
            activate Controller
            Controller -> DAO: 23. layDanhSachHangHoa()
            activate DAO
            DAO -> MySQL: 24. SELECT vá»›i JOIN táº¥t cáº£ báº£ng
            activate MySQL
            MySQL --> DAO: 25. Updated ResultSet
            deactivate MySQL
            DAO --> Controller: 26. List<HangHoa> updated
            deactivate DAO
            Controller --> GUI: 27. List<HangHoa> updated
            deactivate Controller
            
            GUI -> GUI: 28. clearForm() - Clear input fields
            GUI --> User: 29. âœ… "ThÃªm thá»±c pháº©m thÃ nh cÃ´ng!"
        else ThÃªm tháº¥t báº¡i
            GUI --> User: 30. âŒ "Lá»—i: KhÃ´ng thá»ƒ thÃªm thá»±c pháº©m!"
        end
        
    else Validation tháº¥t báº¡i
        Controller --> GUI: âŒ Error message (validation failed)
        GUI --> User: Error message display
        deactivate Controller
    end
    
else Dá»¯ liá»‡u khÃ´ng há»£p lá»‡ (GUI level)
    GUI --> User: âŒ "Vui lÃ²ng kiá»ƒm tra láº¡i thÃ´ng tin!"
end
deactivate GUI

== 2ï¸âƒ£ USE CASE: Xem danh sÃ¡ch táº¥t cáº£ hÃ ng hÃ³a ==

User -> GUI: 1. Click tab "ï¿½ Danh sÃ¡ch hÃ ng hÃ³a" hoáº·c "ğŸ”„ LÃ m má»›i"
activate GUI

GUI -> Controller: 2. layDanhSachHangHoa()
activate Controller

Controller -> DAO: 3. layDanhSachHangHoa()
activate DAO

DAO -> DB: 4. getConnection()
activate DB
DB --> DAO: 5. Connection
deactivate DB

DAO -> MySQL: 6. SELECT h.*, tp.NgaySanXuat, tp.NgayHetHan, tp.NhaCungCap,\n              dm.ThoiGianBaoHanh, dm.CongSuat,\n              ss.NhaSanXuat, ss.NgayNhapKho\n       FROM HangHoa h\n       LEFT JOIN ThucPham tp ON h.MaHang = tp.MaHang\n       LEFT JOIN DienMay dm ON h.MaHang = dm.MaHang\n       LEFT JOIN SanhSu ss ON h.MaHang = ss.MaHang
activate MySQL

MySQL --> DAO: 7. ResultSet with all products
deactivate MySQL

DAO -> DAO: 8. Process ResultSet
loop Cho má»—i row trong ResultSet
    alt LoaiHang = 'ThucPham'
        DAO -> Food: 9a. new ThucPham(...)
        activate Food
        Food --> DAO: ThucPham object
        deactivate Food
    else LoaiHang = 'DienMay'
        DAO -> Electric: 9b. new DienMay(...)
        activate Electric
        Electric --> DAO: DienMay object
        deactivate Electric
    else LoaiHang = 'SanhSu'
        DAO -> Ceramic: 9c. new SanhSu(...)
        activate Ceramic
        Ceramic --> DAO: SanhSu object
        deactivate Ceramic
    end
    DAO -> DAO: Add to products list
end

DAO --> Controller: 10. List<HangHoa> complete
deactivate DAO

Controller --> GUI: 11. List<HangHoa> complete
deactivate Controller

GUI -> GUI: 12. Clear table model (setRowCount(0))
GUI -> GUI: 13. Populate table with new data
loop Cho má»—i HangHoa trong list
    GUI -> GUI: 14. Determine product type and format data
    GUI -> GUI: 15. addRow(maHang, tenHang, loai,\n              soLuong, donGia, vatPercent, giaCoVAT, thongTinDacBiet)
end

GUI -> GUI: 16. updateStatisticsBar() - Update bottom info
GUI --> User: 17. ğŸ“‹ Danh sÃ¡ch hÃ ng hÃ³a Ä‘Æ°á»£c hiá»ƒn thá»‹ trong báº£ng
deactivate GUI

== 3ï¸âƒ£ USE CASE: TÃ¬m kiáº¿m sáº£n pháº©m sáº¯p háº¿t háº¡n ==

User -> GUI: 1. Click tab "ğŸ” TÃ¬m kiáº¿m"
User -> GUI: 2. Click "âš ï¸ Sáº£n pháº©m sáº¯p háº¿t háº¡n"
activate GUI

GUI -> Controller: 3. timSanPhamSapHetHan()
activate Controller

Controller -> DAO: 4. timSanPhamSapHetHanTrongTuan()
activate DAO

DAO -> MySQL: 5. SELECT h.*, tp.NgaySanXuat, tp.NgayHetHan, tp.NhaCungCap\n       FROM HangHoa h\n       JOIN ThucPham tp ON h.MaHang = tp.MaHang\n       WHERE tp.NgayHetHan BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 7 DAY)\n       ORDER BY tp.NgayHetHan ASC
activate MySQL

MySQL --> DAO: 6. ResultSet sáº£n pháº©m sáº¯p háº¿t háº¡n
deactivate MySQL

DAO -> DAO: 7. Convert to ThucPham objects
loop Cho má»—i row
    DAO -> Food: 8. new ThucPham(...)
    activate Food
    Food --> DAO: ThucPham object
    deactivate Food
end

DAO --> Controller: 9. List<ThucPham> sáº¯p háº¿t háº¡n
deactivate DAO

Controller --> GUI: 10. List<ThucPham> sáº¯p háº¿t háº¡n
deactivate Controller

GUI -> GUI: 11. Format vÃ  hiá»ƒn thá»‹ trong txtResults (TextArea)
note right: Hiá»ƒn thá»‹:\n- MÃ£ hÃ ng\n- TÃªn hÃ ng\n- NgÃ y háº¿t háº¡n\n- Sá»‘ ngÃ y cÃ²n láº¡i

GUI --> User: 12. ğŸ“ Danh sÃ¡ch sáº£n pháº©m sáº¯p háº¿t háº¡n vá»›i chi tiáº¿t
deactivate GUI

== 4ï¸âƒ£ USE CASE: Cáº­p nháº­t hÃ ng hÃ³a ==

User -> GUI: 1. Chá»n row trong table
activate GUI
User -> GUI: 2. Click "âœï¸ Sá»­a"

GUI -> GUI: 3. Láº¥y mÃ£ hÃ ng tá»« selected row
GUI -> Controller: 4. timHangHoa(maHang)
activate Controller
Controller -> DAO: 5. timHangHoa(maHang)
activate DAO
DAO -> MySQL: 6. SELECT vá»›i JOIN Ä‘á»ƒ láº¥y thÃ´ng tin Ä‘áº§y Ä‘á»§
activate MySQL
MySQL --> DAO: 7. ResultSet
deactivate MySQL
DAO --> Controller: 8. HangHoa object (vá»›i subtype)
deactivate DAO
Controller --> GUI: 9. HangHoa object
deactivate Controller

GUI -> GUI: 10. Má»Ÿ EditDialog vá»›i dá»¯ liá»‡u hiá»‡n táº¡i
GUI -> GUI: 11. User chá»‰nh sá»­a thÃ´ng tin

User -> GUI: 12. Click "ğŸ’¾ LÆ°u" trong EditDialog
GUI -> GUI: 13. Validate new data

alt Dá»¯ liá»‡u há»£p lá»‡
    GUI -> Controller: 14. capNhatHangHoa(hangHoa)
    activate Controller
    
    Controller -> Controller: 15. Validate business rules
    note right: Similar validation nhÆ° thÃªm má»›i
    
    Controller -> DAO: 16. capNhatHangHoa(hangHoa)
    activate DAO
    
    DAO -> MySQL: 17. BEGIN TRANSACTION
    activate MySQL
    DAO -> MySQL: 18. UPDATE HangHoa SET TenHang=?, SoLuongTon=?, DonGia=?\n        WHERE MaHang=?
    
    alt HangHoa lÃ  ThucPham
        DAO -> MySQL: 19a. UPDATE ThucPham SET NgaySanXuat=?, NgayHetHan=?, NhaCungCap=?\n         WHERE MaHang=?
    else HangHoa lÃ  DienMay
        DAO -> MySQL: 19b. UPDATE DienMay SET ThoiGianBaoHanh=?, CongSuat=?\n         WHERE MaHang=?
    else HangHoa lÃ  SanhSu
        DAO -> MySQL: 19c. UPDATE SanhSu SET NhaSanXuat=?, NgayNhapKho=?\n         WHERE MaHang=?
    end
    
    DAO -> MySQL: 20. COMMIT
    
    alt Update thÃ nh cÃ´ng
        MySQL --> DAO: 21a. Update successful
        DAO --> Controller: 22a. true
        Controller --> GUI: 23a. true
        
        GUI -> GUI: 24. Close EditDialog
        GUI -> GUI: 25. loadData() - Refresh main table
        GUI --> User: 26. âœ… "Cáº­p nháº­t thÃ nh cÃ´ng!"
    else Update tháº¥t báº¡i
        MySQL --> DAO: 21b. ERROR
        DAO -> MySQL: ROLLBACK
        DAO --> Controller: 22b. false
        Controller --> GUI: 23b. false
        GUI --> User: âŒ "Lá»—i cáº­p nháº­t!"
    end
    
    deactivate MySQL
    deactivate DAO
    deactivate Controller
    
else Dá»¯ liá»‡u khÃ´ng há»£p lá»‡
    GUI --> User: âŒ "Dá»¯ liá»‡u khÃ´ng há»£p lá»‡!"
end
deactivate GUI

== 5ï¸âƒ£ USE CASE: XÃ³a hÃ ng hÃ³a ==

User -> GUI: 1. Chá»n row trong table
User -> GUI: 2. Click "ğŸ—‘ï¸ XÃ³a"
activate GUI

GUI -> GUI: 3. Hiá»ƒn thá»‹ confirmation dialog
note right: "Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a hÃ ng hÃ³a nÃ y?"

alt User confirms deletion
    GUI -> GUI: 4. Láº¥y mÃ£ hÃ ng tá»« selected row
    GUI -> Controller: 5. xoaHangHoa(maHang)
    activate Controller
    
    Controller -> DAO: 6. xoaHangHoa(maHang)
    activate DAO
    
    DAO -> MySQL: 7. BEGIN TRANSACTION
    activate MySQL
    
    DAO -> MySQL: 8. Determine product type
    note right: SELECT LoaiHang FROM HangHoa WHERE MaHang=?
    
    alt Product type determined
        DAO -> MySQL: 9. DELETE FROM ThucPham/DienMay/SanhSu WHERE MaHang=?
        note right: XÃ³a tá»« báº£ng con trÆ°á»›c\ndo foreign key constraint
        DAO -> MySQL: 10. DELETE FROM HangHoa WHERE MaHang=?
        DAO -> MySQL: 11. COMMIT
        
        alt Delete thÃ nh cÃ´ng
            MySQL --> DAO: 12a. Transaction successful
            DAO --> Controller: 13a. true
            Controller --> GUI: 14a. true
            
            GUI -> GUI: 15. loadData() - Refresh table
            GUI -> GUI: 16. updateStatisticsBar()
            GUI --> User: 17. âœ… "XÃ³a hÃ ng hÃ³a thÃ nh cÃ´ng!"
        else Delete tháº¥t báº¡i
            MySQL --> DAO: 12b. ERROR
            DAO -> MySQL: ROLLBACK
            DAO --> Controller: 13b. false
            Controller --> GUI: 14b. false
            GUI --> User: âŒ "Lá»—i: KhÃ´ng thá»ƒ xÃ³a hÃ ng hÃ³a!"
        end
    end
    
    deactivate MySQL
    deactivate DAO
    deactivate Controller
    
else User cancels
    GUI --> User: ğŸš« "ÄÃ£ há»§y thao tÃ¡c xÃ³a"
end
deactivate GUI

== 6ï¸âƒ£ USE CASE: Xem thá»‘ng kÃª kho hÃ ng ==

User -> GUI: 1. Click tab "ğŸ“Š Thá»‘ng kÃª"
User -> GUI: 2. Click "ğŸ“Š Cáº­p nháº­t thá»‘ng kÃª"
activate GUI

GUI -> Controller: 3. Multiple statistics calls
activate Controller

par Parallel statistics gathering
    Controller -> DAO: 4a. getSoLuongTheoLoai("thucpham")
    Controller -> DAO: 4b. getSoLuongTheoLoai("dienmay") 
    Controller -> DAO: 4c. getSoLuongTheoLoai("sanhsu")
    Controller -> DAO: 4d. tinhTongGiaTriKho()
    Controller -> DAO: 4e. tinhTongGiaTriCoVAT()
    Controller -> DAO: 4f. tinhTrungBinhSoLuongDienMay()
    Controller -> DAO: 4g. timSanPhamSapHetHanTrongTuan()
end

activate DAO
DAO -> MySQL: 5. Multiple SELECT queries for statistics
activate MySQL
note right: - COUNT by LoaiHang\n- SUM calculations\n- AVG for DienMay\n- Date-based filtering for expiry
MySQL --> DAO: 6. Various ResultSets
deactivate MySQL
DAO --> Controller: 7. Statistics data
deactivate DAO

Controller --> GUI: 8. Formatted statistics data
deactivate Controller

GUI -> GUI: 9. updateStatistics(txtStats)
note right: Format statistics into readable text:\n- Product counts by type\n- Total values\n- Average quantities\n- Expiring products list

GUI --> User: 10. ğŸ“Š Complete statistics display
deactivate GUI

@enduml
