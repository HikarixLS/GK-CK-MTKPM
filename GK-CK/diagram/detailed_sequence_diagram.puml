@startuml Detailed CRUD Operations - Sequence Diagram

!theme plain
skinparam backgroundColor white
skinparam sequenceArrowThickness 2
skinparam roundcorner 15
skinparam maxmessagesize 70

actor User as "ğŸ‘¤ NgÆ°á»i dÃ¹ng"
participant GUI as "ğŸ–¥ï¸ KhoGUI\n<<Swing Interface>>"
participant DAO as "ğŸ—ƒï¸ HangHoaDAO\n<<Data Access Layer>>"
participant Product as "ğŸ“¦ HangHoa\n<<Abstract Entity>>"
participant Food as "ğŸ¥— ThucPham\n<<Concrete Entity>>"
participant Electric as "âš¡ DienMay\n<<Concrete Entity>>"
participant Ceramic as "ğŸº SanhSu\n<<Concrete Entity>>"
participant DB as "ğŸ”— DatabaseConnection\n<<Singleton>>"
database MySQL as "ğŸ—„ï¸ MySQL Database\n<<QuanLyKhoHang>>"

title ğŸª Há»‡ thá»‘ng Quáº£n lÃ½ Kho - Chi tiáº¿t thao tÃ¡c CRUD

== 1ï¸âƒ£ USE CASE: ThÃªm Thá»±c pháº©m má»›i ==

User -> GUI: 1. Nháº­p thÃ´ng tin thá»±c pháº©m
activate GUI
note right: MÃ£ hÃ ng, tÃªn, sá»‘ lÆ°á»£ng,\nÄ‘Æ¡n giÃ¡, ngÃ y SX, ngÃ y HH,\nnhÃ  cung cáº¥p

GUI -> GUI: 2. Validate input data
alt Dá»¯ liá»‡u há»£p lá»‡
    GUI -> Food: 3. new ThucPham(maHang, tenHang, soLuong,\n                 donGia, ngaySX, ngayHH, nhaCungCap)
    activate Food
    
    Food -> Food: 4. Validate business rules
    note right: - Kiá»ƒm tra ngÃ y háº¿t háº¡n > ngÃ y SX\n- Kiá»ƒm tra sá»‘ lÆ°á»£ng >= 0\n- Kiá»ƒm tra Ä‘Æ¡n giÃ¡ > 0
    
    Food --> GUI: 5. ThucPham object created
    deactivate Food
    
    GUI -> DAO: 6. themThucPham(thucPham)
    activate DAO
    
    DAO -> DB: 7. getConnection()
    activate DB
    DB -> MySQL: 8. Establish connection
    activate MySQL
    MySQL --> DB: 9. Connection ready
    DB --> DAO: 10. Connection object
    deactivate DB
    
    DAO -> MySQL: 11. CALL SP_ThemThucPham(maHang, tenHang,\n                      soLuong, donGia, ngaySX, ngayHH, nhaCungCap)
    
    alt Stored Procedure thÃ nh cÃ´ng
        MySQL --> DAO: 12a. SUCCESS result
        note right: Stored procedure tá»± Ä‘á»™ng:\n- INSERT vÃ o HangHoa\n- INSERT vÃ o ThucPham\n- Set VAT = 5%
    else Stored Procedure tháº¥t báº¡i
        MySQL --> DAO: 12b. ERROR result
        DAO -> DAO: 13. themThucPhamDirect() [Fallback]
        
        DAO -> MySQL: 14a. BEGIN TRANSACTION
        DAO -> MySQL: 14b. INSERT INTO HangHoa\n       (MaHang, TenHang, LoaiHang, SoLuongTon, DonGia, VAT)\n       VALUES (?, ?, 'ThucPham', ?, ?, 0.05)
        DAO -> MySQL: 14c. INSERT INTO ThucPham\n       (MaHang, NgaySanXuat, NgayHetHan, NhaCungCap)\n       VALUES (?, ?, ?, ?)
        DAO -> MySQL: 14d. COMMIT
        MySQL --> DAO: 14e. Transaction successful
    end
    
    deactivate MySQL
    DAO --> GUI: 15. boolean result (true)
    deactivate DAO
    
    GUI -> GUI: 16. loadData() - Refresh table
    GUI -> DAO: 17. layTatCaHangHoa()
    activate DAO
    DAO -> MySQL: 18. SELECT * FROM view_all_products
    activate MySQL
    MySQL --> DAO: 19. Updated ResultSet
    deactivate MySQL
    DAO --> GUI: 20. List<HangHoa> updated
    deactivate DAO
    
    GUI --> User: 21. âœ… "ThÃªm thá»±c pháº©m thÃ nh cÃ´ng!"
    
else Dá»¯ liá»‡u khÃ´ng há»£p lá»‡
    GUI --> User: âŒ "Vui lÃ²ng kiá»ƒm tra láº¡i thÃ´ng tin!"
end
deactivate GUI

== 2ï¸âƒ£ USE CASE: Xem danh sÃ¡ch táº¥t cáº£ hÃ ng hÃ³a ==

User -> GUI: 1. Click button "ğŸ“‹ Xem táº¥t cáº£"
activate GUI

GUI -> DAO: 2. layTatCaHangHoa()
activate DAO

DAO -> DB: 3. getConnection()
activate DB
DB --> DAO: 4. Connection
deactivate DB

DAO -> MySQL: 5. SELECT hh.MaHang, hh.TenHang, hh.LoaiHang, hh.SoLuongTon,\n              hh.DonGia, hh.VAT,\n              tp.NgaySanXuat, tp.NgayHetHan, tp.NhaCungCap,\n              dm.ThoiGianBaoHanh, dm.CongSuat,\n              ss.NhaSanXuat, ss.NgayNhapKho\n       FROM HangHoa hh\n       LEFT JOIN ThucPham tp ON hh.MaHang = tp.MaHang\n       LEFT JOIN DienMay dm ON hh.MaHang = dm.MaHang\n       LEFT JOIN SanhSu ss ON hh.MaHang = ss.MaHang
activate MySQL

MySQL --> DAO: 6. ResultSet with all products
deactivate MySQL

DAO -> DAO: 7. Process ResultSet
loop Cho má»—i row trong ResultSet
    alt LoaiHang = 'ThucPham'
        DAO -> Food: 8a. new ThucPham(...)
        activate Food
        Food --> DAO: ThucPham object
        deactivate Food
    else LoaiHang = 'DienMay'
        DAO -> Electric: 8b. new DienMay(...)
        activate Electric
        Electric --> DAO: DienMay object
        deactivate Electric
    else LoaiHang = 'SanhSu'
        DAO -> Ceramic: 8c. new SanhSu(...)
        activate Ceramic
        Ceramic --> DAO: SanhSu object
        deactivate Ceramic
    end
    DAO -> DAO: Add to products list
end

DAO --> GUI: 9. List<HangHoa> complete
deactivate DAO

GUI -> GUI: 10. Clear table model
GUI -> GUI: 11. Populate table with new data
loop Cho má»—i HangHoa trong list
    GUI -> GUI: 12. addRow(maHang, tenHang, loaiHang,\n              soLuong, donGia, vatPercent)
end

GUI --> User: 13. ğŸ“‹ Danh sÃ¡ch hÃ ng hÃ³a Ä‘Æ°á»£c hiá»ƒn thá»‹
deactivate GUI

== 3ï¸âƒ£ USE CASE: TÃ¬m kiáº¿m sáº£n pháº©m sáº¯p háº¿t háº¡n ==

User -> GUI: 1. Click "â° Sáº¯p háº¿t háº¡n (1 tuáº§n)"
activate GUI

GUI -> DAO: 2. layHangSapHetHan()
activate DAO

DAO -> MySQL: 3. CALL SP_LayHangSapHetHan() hoáº·c\n       SELECT * FROM ThucPham tp\n       JOIN HangHoa hh ON tp.MaHang = hh.MaHang\n       WHERE tp.NgayHetHan BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 7 DAY)
activate MySQL

MySQL --> DAO: 4. ResultSet sáº£n pháº©m sáº¯p háº¿t háº¡n
deactivate MySQL

DAO -> DAO: 5. Convert to ThucPham objects
loop Cho má»—i row
    DAO -> Food: 6. new ThucPham(...)
    activate Food
    Food --> DAO: ThucPham object
    deactivate Food
end

DAO --> GUI: 7. List<ThucPham> sáº¯p háº¿t háº¡n
deactivate DAO

GUI -> GUI: 8. Hiá»ƒn thá»‹ trong txtKQ (TextArea)
GUI --> User: 9. ğŸ“ Danh sÃ¡ch sáº£n pháº©m sáº¯p háº¿t háº¡n
deactivate GUI

== 4ï¸âƒ£ USE CASE: Cáº­p nháº­t hÃ ng hÃ³a ==

User -> GUI: 1. Chá»n row trong table
activate GUI
GUI -> GUI: 2. selectItem() - Load data to form

User -> GUI: 3. Sá»­a thÃ´ng tin
User -> GUI: 4. Click "âœï¸ Sá»­a"

GUI -> GUI: 5. Validate new data
alt Dá»¯ liá»‡u há»£p lá»‡
    GUI -> DAO: 6. capNhatHangHoa(hangHoa)
    activate DAO
    
    DAO -> MySQL: 7. UPDATE HangHoa SET TenHang=?, SoLuongTon=?, DonGia=?\n       WHERE MaHang=?
    activate MySQL
    
    alt Loáº¡i hÃ ng = ThucPham
        DAO -> MySQL: 8a. UPDATE ThucPham SET NgaySanXuat=?, NgayHetHan=?, NhaCungCap=?\n        WHERE MaHang=?
    else Loáº¡i hÃ ng = DienMay
        DAO -> MySQL: 8b. UPDATE DienMay SET ThoiGianBaoHanh=?, CongSuat=?\n        WHERE MaHang=?
    else Loáº¡i hÃ ng = SanhSu
        DAO -> MySQL: 8c. UPDATE SanhSu SET NhaSanXuat=?, NgayNhapKho=?\n        WHERE MaHang=?
    end
    
    MySQL --> DAO: 9. Update successful
    deactivate MySQL
    DAO --> GUI: 10. true
    deactivate DAO
    
    GUI -> GUI: 11. loadData() - Refresh
    GUI --> User: 12. âœ… "Cáº­p nháº­t thÃ nh cÃ´ng!"
else Dá»¯ liá»‡u khÃ´ng há»£p lá»‡
    GUI --> User: âŒ "Dá»¯ liá»‡u khÃ´ng há»£p lá»‡!"
end
deactivate GUI

== 5ï¸âƒ£ USE CASE: XÃ³a hÃ ng hÃ³a ==

User -> GUI: 1. Chá»n row vÃ  click "ğŸ—‘ï¸ XÃ³a"
activate GUI

GUI -> GUI: 2. Confirm dialog
alt User confirms
    GUI -> DAO: 3. xoaHangHoa(maHang)
    activate DAO
    
    DAO -> MySQL: 4. BEGIN TRANSACTION
    activate MySQL
    DAO -> MySQL: 5. DELETE FROM ThucPham/DienMay/SanhSu WHERE MaHang=?
    DAO -> MySQL: 6. DELETE FROM HangHoa WHERE MaHang=?
    DAO -> MySQL: 7. COMMIT
    MySQL --> DAO: 8. Transaction successful
    deactivate MySQL
    
    DAO --> GUI: 9. true
    deactivate DAO
    
    GUI -> GUI: 10. loadData()
    GUI --> User: 11. âœ… "XÃ³a thÃ nh cÃ´ng!"
else User cancels
    GUI --> User: ğŸš« "ÄÃ£ há»§y thao tÃ¡c"
end
deactivate GUI

@enduml
