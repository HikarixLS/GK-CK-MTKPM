package view;

import controller.HangHoaController;
import model.*;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Scanner;

/**
 * Console View cho Warehouse Management System
 * View Layer trong MVC Pattern
 */
public class ConsoleView {
    private HangHoaController controller;
    private Scanner scanner;
    
    public ConsoleView() {
        this.controller = new HangHoaController();
        this.scanner = new Scanner(System.in);
    }
    
    public void start() {
        System.out.println("üè™ WAREHOUSE MANAGEMENT SYSTEM - CONSOLE MODE");
        System.out.println("=========================================");
        System.out.println("üìã MVC Pattern Implementation");
        System.out.println("=========================================\n");
        
        int choice;
        do {
            displayMenu();
            choice = getIntInput("üëâ Ch·ªçn ch·ª©c nƒÉng (0-9): ");
            
            switch (choice) {
                case 1:
                    themHangHoa();
                    break;
                case 2:
                    hienThiDanhSach();
                    break;
                case 3:
                    timKiemHangHoa();
                    break;
                case 4:
                    capNhatHangHoa();
                    break;
                case 5:
                    xoaHangHoa();
                    break;
                case 6:
                    hienThiThongKe();
                    break;
                case 7:
                    timSanPhamSapHetHan();
                    break;
                case 8:
                    xemChiTietHangHoa();
                    break;
                case 9:
                    hienThiGiaTriKho();
                    break;
                case 0:
                    System.out.println("üëã C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng h·ªá th·ªëng!");
                    break;
                default:
                    System.out.println("‚ùå L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!");
            }
            
            if (choice != 0) {
                System.out.println("\n‚è∏Ô∏è Nh·∫•n Enter ƒë·ªÉ ti·∫øp t·ª•c...");
                scanner.nextLine();
            }
            
        } while (choice != 0);
    }
    
    private void displayMenu() {
        System.out.println("\nüè™ ==== MENU CH√çNH ====");
        System.out.println("1Ô∏è‚É£  Th√™m h√†ng h√≥a");
        System.out.println("2Ô∏è‚É£  Hi·ªÉn th·ªã danh s√°ch h√†ng h√≥a");
        System.out.println("3Ô∏è‚É£  T√¨m ki·∫øm h√†ng h√≥a");
        System.out.println("4Ô∏è‚É£  C·∫≠p nh·∫≠t th√¥ng tin h√†ng h√≥a");
        System.out.println("5Ô∏è‚É£  X√≥a h√†ng h√≥a");
        System.out.println("6Ô∏è‚É£  Hi·ªÉn th·ªã th·ªëng k√™");
        System.out.println("7Ô∏è‚É£  T√¨m s·∫£n ph·∫©m s·∫Øp h·∫øt h·∫°n");
        System.out.println("8Ô∏è‚É£  Xem chi ti·∫øt h√†ng h√≥a");
        System.out.println("9Ô∏è‚É£  Hi·ªÉn th·ªã gi√° tr·ªã kho h√†ng");
        System.out.println("0Ô∏è‚É£  Tho√°t");
        System.out.println("========================");
    }
    
    private void themHangHoa() {
        System.out.println("\n‚ûï ==== TH√äM H√ÄNG H√ìA ====");
        
        System.out.println("Ch·ªçn lo·∫°i h√†ng h√≥a:");
        System.out.println("1. Th·ª±c ph·∫©m");
        System.out.println("2. ƒêi·ªán m√°y");
        System.out.println("3. S√†nh s·ª©");
        
        int loai = getIntInput("üëâ Ch·ªçn lo·∫°i (1-3): ");
        
        switch (loai) {
            case 1:
                themThucPham();
                break;
            case 2:
                themDienMay();
                break;
            case 3:
                themSanhSu();
                break;
            default:
                System.out.println("‚ùå Lo·∫°i h√†ng h√≥a kh√¥ng h·ª£p l·ªá!");
        }
    }
    
    private void themThucPham() {
        System.out.println("\nüçé TH√äM TH·ª∞C PH·∫®M");
        System.out.println("==================");
        
        String maHang = getStringInput("M√£ h√†ng: ");
        String tenHang = getStringInput("T√™n h√†ng: ");
        int soLuong = getIntInput("S·ªë l∆∞·ª£ng t·ªìn: ");
        double donGia = getDoubleInput("ƒê∆°n gi√°: ");
        String ngaySanXuat = getStringInput("Ng√†y s·∫£n xu·∫•t (dd/MM/yyyy): ");
        String ngayHetHan = getStringInput("Ng√†y h·∫øt h·∫°n (dd/MM/yyyy): ");
        String nhaCungCap = getStringInput("Nh√† cung c·∫•p: ");
        
        if (controller.themThucPham(maHang, tenHang, soLuong, donGia, 
                                   ngaySanXuat, ngayHetHan, nhaCungCap)) {
            System.out.println("‚úÖ Th√™m th·ª±c ph·∫©m th√†nh c√¥ng!");
        } else {
            System.out.println("‚ùå Th√™m th·ª±c ph·∫©m th·∫•t b·∫°i!");
        }
    }
    
    private void themDienMay() {
        System.out.println("\n‚ö° TH√äM ƒêI·ªÜN M√ÅY");
        System.out.println("================");
        
        String maHang = getStringInput("M√£ h√†ng: ");
        String tenHang = getStringInput("T√™n h√†ng: ");
        int soLuong = getIntInput("S·ªë l∆∞·ª£ng t·ªìn: ");
        double donGia = getDoubleInput("ƒê∆°n gi√°: ");
        int thoiGianBaoHanh = getIntInput("Th·ªùi gian b·∫£o h√†nh (th√°ng): ");
        double congSuat = getDoubleInput("C√¥ng su·∫•t (KW): ");
        
        if (controller.themDienMay(maHang, tenHang, soLuong, donGia, 
                                  thoiGianBaoHanh, congSuat)) {
            System.out.println("‚úÖ Th√™m ƒëi·ªán m√°y th√†nh c√¥ng!");
        } else {
            System.out.println("‚ùå Th√™m ƒëi·ªán m√°y th·∫•t b·∫°i!");
        }
    }
    
    private void themSanhSu() {
        System.out.println("\nüè∫ TH√äM S√ÄNH S·ª®");
        System.out.println("===============");
        
        String maHang = getStringInput("M√£ h√†ng: ");
        String tenHang = getStringInput("T√™n h√†ng: ");
        int soLuong = getIntInput("S·ªë l∆∞·ª£ng t·ªìn: ");
        double donGia = getDoubleInput("ƒê∆°n gi√°: ");
        String nhaSanXuat = getStringInput("Nh√† s·∫£n xu·∫•t: ");
        String ngayNhapKho = getStringInput("Ng√†y nh·∫≠p kho (dd/MM/yyyy): ");
        
        if (controller.themSanhSu(maHang, tenHang, soLuong, donGia, 
                                 nhaSanXuat, ngayNhapKho)) {
            System.out.println("‚úÖ Th√™m s√†nh s·ª© th√†nh c√¥ng!");
        } else {
            System.out.println("‚ùå Th√™m s√†nh s·ª© th·∫•t b·∫°i!");
        }
    }
    
    private void hienThiDanhSach() {
        System.out.println("\nüì¶ ==== DANH S√ÅCH H√ÄNG H√ìA ====");
        
        List<HangHoa> danhSach = controller.layDanhSachHangHoa();
        
        if (danhSach.isEmpty()) {
            System.out.println("üì≠ Danh s√°ch tr·ªëng!");
            return;
        }
        
        System.out.println("================================================================================================");
        System.out.printf("%-10s %-25s %-12s %-8s %-15s %-8s %-15s %-20s%n", 
                         "M√£ h√†ng", "T√™n h√†ng", "Lo·∫°i", "SL t·ªìn", "ƒê∆°n gi√°", "VAT(%)", "Gi√° c√≥ VAT", "Th√¥ng tin ƒë·∫∑c bi·ªát");
        System.out.println("================================================================================================");
        
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("dd/MM/yyyy");
        
        for (HangHoa hh : danhSach) {
            String loai = "";
            String thongTinDacBiet = "";
            
            if (hh instanceof ThucPham) {
                ThucPham tp = (ThucPham) hh;
                loai = "Th·ª±c ph·∫©m";
                thongTinDacBiet = "HSD: " + tp.getNgayHetHan().format(formatter);
            } else if (hh instanceof DienMay) {
                DienMay dm = (DienMay) hh;
                loai = "ƒêi·ªán m√°y";
                thongTinDacBiet = "BH: " + dm.getThoiGianBaoHanh() + "th, " + dm.getCongSuat() + "KW";
            } else if (hh instanceof SanhSu) {
                SanhSu ss = (SanhSu) hh;
                loai = "S√†nh s·ª©";
                thongTinDacBiet = "NSX: " + ss.getNhaSanXuat();
            }
            
            System.out.printf("%-10s %-25s %-12s %-8d %,15.0f %8.1f %,15.0f %-20s%n",
                             hh.getMaHang(),
                             hh.getTenHang().length() > 25 ? hh.getTenHang().substring(0, 22) + "..." : hh.getTenHang(),
                             loai,
                             hh.getSoLuongTon(),
                             hh.getDonGia(),
                             hh.getVATRate(),
                             hh.getGiaCoVAT(),
                             thongTinDacBiet);
        }
        
        System.out.println("================================================================================================");
        System.out.printf("üìä T·ªïng s·ªë s·∫£n ph·∫©m: %d | T·ªïng gi√° tr·ªã c√≥ VAT: %,.0f VNƒê%n", 
                         danhSach.size(), controller.tinhTongGiaTriCoVAT());
    }
    
    private void timKiemHangHoa() {
        System.out.println("\nüîç ==== T√åM KI·∫æM H√ÄNG H√ìA ====");
        
        String maHang = getStringInput("Nh·∫≠p m√£ h√†ng c·∫ßn t√¨m: ");
        HangHoa hangHoa = controller.timHangHoa(maHang);
        
        if (hangHoa != null) {
            System.out.println("‚úÖ T√¨m th·∫•y h√†ng h√≥a:");
            hienThiChiTiet(hangHoa);
        } else {
            System.out.println("‚ùå Kh√¥ng t√¨m th·∫•y h√†ng h√≥a v·ªõi m√£: " + maHang);
        }
    }
    
    private void capNhatHangHoa() {
        System.out.println("\n‚úèÔ∏è ==== C·∫¨P NH·∫¨T H√ÄNG H√ìA ====");
        
        String maHang = getStringInput("Nh·∫≠p m√£ h√†ng c·∫ßn c·∫≠p nh·∫≠t: ");
        HangHoa hangHoa = controller.timHangHoa(maHang);
        
        if (hangHoa == null) {
            System.out.println("‚ùå Kh√¥ng t√¨m th·∫•y h√†ng h√≥a v·ªõi m√£: " + maHang);
            return;
        }
        
        System.out.println("üìã Th√¥ng tin hi·ªán t·∫°i:");
        hienThiChiTiet(hangHoa);
        
        System.out.println("\nüìù Nh·∫≠p th√¥ng tin m·ªõi:");
        String tenHang = getStringInput("T√™n h√†ng m·ªõi (hi·ªán t·∫°i: " + hangHoa.getTenHang() + "): ");
        int soLuong = getIntInput("S·ªë l∆∞·ª£ng t·ªìn m·ªõi (hi·ªán t·∫°i: " + hangHoa.getSoLuongTon() + "): ");
        double donGia = getDoubleInput("ƒê∆°n gi√° m·ªõi (hi·ªán t·∫°i: " + hangHoa.getDonGia() + "): ");
        
        if (controller.capNhatHangHoa(maHang, tenHang, soLuong, donGia)) {
            System.out.println("‚úÖ C·∫≠p nh·∫≠t h√†ng h√≥a th√†nh c√¥ng!");
        } else {
            System.out.println("‚ùå C·∫≠p nh·∫≠t h√†ng h√≥a th·∫•t b·∫°i!");
        }
    }
    
    private void xoaHangHoa() {
        System.out.println("\nüóëÔ∏è ==== X√ìA H√ÄNG H√ìA ====");
        
        String maHang = getStringInput("Nh·∫≠p m√£ h√†ng c·∫ßn x√≥a: ");
        HangHoa hangHoa = controller.timHangHoa(maHang);
        
        if (hangHoa == null) {
            System.out.println("‚ùå Kh√¥ng t√¨m th·∫•y h√†ng h√≥a v·ªõi m√£: " + maHang);
            return;
        }
        
        System.out.println("üìã Th√¥ng tin h√†ng h√≥a s·∫Ω b·ªã x√≥a:");
        hienThiChiTiet(hangHoa);
        
        String confirm = getStringInput("\n‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a? (y/N): ");
        if (confirm.equalsIgnoreCase("y") || confirm.equalsIgnoreCase("yes")) {
            if (controller.xoaHangHoa(maHang)) {
                System.out.println("‚úÖ X√≥a h√†ng h√≥a th√†nh c√¥ng!");
            } else {
                System.out.println("‚ùå X√≥a h√†ng h√≥a th·∫•t b·∫°i!");
            }
        } else {
            System.out.println("‚Ü©Ô∏è ƒê√£ h·ªßy thao t√°c x√≥a.");
        }
    }
    
    private void hienThiThongKe() {
        System.out.println("\nüìä ==== TH·ªêNG K√ä KHO H√ÄNG ====");
        
        int soThucPham = controller.getSoLuongTheoLoai("thucpham");
        int soDienMay = controller.getSoLuongTheoLoai("dienmay");
        int soSanhSu = controller.getSoLuongTheoLoai("sanhsu");
        int tongSo = soThucPham + soDienMay + soSanhSu;
        
        System.out.println("==========================================");
        System.out.printf("üçé Th·ª±c ph·∫©m:    %3d s·∫£n ph·∫©m (%5.1f%%)%n", 
                         soThucPham, tongSo > 0 ? (soThucPham * 100.0 / tongSo) : 0);
        System.out.printf("‚ö° ƒêi·ªán m√°y:     %3d s·∫£n ph·∫©m (%5.1f%%)%n", 
                         soDienMay, tongSo > 0 ? (soDienMay * 100.0 / tongSo) : 0);
        System.out.printf("üè∫ S√†nh s·ª©:      %3d s·∫£n ph·∫©m (%5.1f%%)%n", 
                         soSanhSu, tongSo > 0 ? (soSanhSu * 100.0 / tongSo) : 0);
        System.out.println("------------------------------------------");
        System.out.printf("üì¶ T·ªïng c·ªông:    %3d s·∫£n ph·∫©m%n", tongSo);
        System.out.println("==========================================");
        
        double tongGiaTri = controller.tinhTongGiaTriKho();
        System.out.printf("üí∞ T·ªïng gi√° tr·ªã kho: %,.0f VNƒê%n", tongGiaTri);
        
        double trungBinhDienMay = controller.tinhTrungBinhSoLuongDienMay();
        System.out.printf("üìä Trung b√¨nh SL ƒëi·ªán m√°y: %.2f%n", trungBinhDienMay);
        
        // Chi ti·∫øt th·ªëng k√™ t·ª´ controller
        System.out.println("\nüìà TH·ªêNG K√ä CHI TI·∫æT:");
        controller.hienThiThongKe();
    }
    
    private void timSanPhamSapHetHan() {
        System.out.println("\n‚ö†Ô∏è ==== S·∫¢N PH·∫®M S·∫ÆP H·∫æT H·∫†N ====");
        
        List<ThucPham> sapHetHan = controller.timSanPhamSapHetHan();
        
        if (sapHetHan.isEmpty()) {
            System.out.println("‚úÖ Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o s·∫Øp h·∫øt h·∫°n trong tu·∫ßn!");
            return;
        }
        
        System.out.println("üö® T√¨m th·∫•y " + sapHetHan.size() + " s·∫£n ph·∫©m s·∫Øp h·∫øt h·∫°n:");
        System.out.println("================================================================");
        System.out.printf("%-10s %-25s %-12s %-15s%n", 
                         "M√£ h√†ng", "T√™n h√†ng", "Ng√†y h·∫øt h·∫°n", "Nh√† cung c·∫•p");
        System.out.println("================================================================");
        
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("dd/MM/yyyy");
        for (ThucPham tp : sapHetHan) {
            System.out.printf("%-10s %-25s %-12s %-15s%n",
                             tp.getMaHang(),
                             tp.getTenHang().length() > 25 ? tp.getTenHang().substring(0, 22) + "..." : tp.getTenHang(),
                             tp.getNgayHetHan().format(formatter),
                             tp.getNhaCungCap());
        }
        System.out.println("================================================================");
    }
    
    private void xemChiTietHangHoa() {
        System.out.println("\nüëÅÔ∏è ==== XEM CHI TI·∫æT H√ÄNG H√ìA ====");
        
        String maHang = getStringInput("Nh·∫≠p m√£ h√†ng: ");
        HangHoa hangHoa = controller.timHangHoa(maHang);
        
        if (hangHoa != null) {
            hienThiChiTiet(hangHoa);
            
            // Th√¥ng tin b·ªï sung
            System.out.println("\nüìä TH√îNG TIN B·ªî SUNG:");
            System.out.printf("üí∞ VAT: %.1f%%%n", hangHoa.getVATRate());
            System.out.printf("üí∞ Gi√° c√≥ VAT: %,.0f VNƒê%n", hangHoa.getGiaCoVAT());
            System.out.printf("üìà H√†ng kh√≥ b√°n: %s%n", hangHoa.daKho() ? "C√≥" : "Kh√¥ng");
            System.out.printf("üíµ T·ªïng gi√° tr·ªã c√≥ VAT: %,.0f VNƒê%n", hangHoa.getTongGiaTriCoVAT());
        } else {
            System.out.println("‚ùå Kh√¥ng t√¨m th·∫•y h√†ng h√≥a v·ªõi m√£: " + maHang);
        }
    }
    
    private void hienThiGiaTriKho() {
        System.out.println("\nüí∞ ==== GI√Å TR·ªä KHO H√ÄNG ====");
        
        List<HangHoa> danhSach = controller.layDanhSachHangHoa();
        double tongGiaTri = controller.tinhTongGiaTriKho();
        double tongGiaTriCoVAT = controller.tinhTongGiaTriCoVAT();
        
        System.out.printf("üì¶ T·ªïng s·ªë s·∫£n ph·∫©m: %d%n", danhSach.size());
        System.out.printf("üí∞ T·ªïng gi√° tr·ªã kho: %,.0f VNƒê%n", tongGiaTri);
        System.out.printf("üí∞ T·ªïng gi√° tr·ªã c√≥ VAT: %,.0f VNƒê%n", tongGiaTriCoVAT);
        
        if (!danhSach.isEmpty()) {
            System.out.printf("üìä Gi√° tr·ªã trung b√¨nh/s·∫£n ph·∫©m: %,.0f VNƒê%n", 
                             tongGiaTri / danhSach.size());
            System.out.printf("üìä Gi√° tr·ªã trung b√¨nh c√≥ VAT/s·∫£n ph·∫©m: %,.0f VNƒê%n", 
                             tongGiaTriCoVAT / danhSach.size());
        }
        
        // Th·ªëng k√™ theo lo·∫°i
        double giaTriThucPham = 0, giaTriDienMay = 0, giaTriSanhSu = 0;
        
        for (HangHoa hh : danhSach) {
            double giaTri = hh.getSoLuongTon() * hh.getDonGia();
            
            if (hh instanceof ThucPham) {
                giaTriThucPham += giaTri;
            } else if (hh instanceof DienMay) {
                giaTriDienMay += giaTri;
            } else if (hh instanceof SanhSu) {
                giaTriSanhSu += giaTri;
            }
        }
        
        System.out.println("\nüíé PH√ÇN T√çCH GI√Å TR·ªä THEO LO·∫†I:");
        System.out.println("=====================================");
        System.out.printf("üçé Th·ª±c ph·∫©m: %,.0f VNƒê (%5.1f%%)%n", 
                         giaTriThucPham, tongGiaTri > 0 ? (giaTriThucPham * 100.0 / tongGiaTri) : 0);
        System.out.printf("‚ö° ƒêi·ªán m√°y:  %,.0f VNƒê (%5.1f%%)%n", 
                         giaTriDienMay, tongGiaTri > 0 ? (giaTriDienMay * 100.0 / tongGiaTri) : 0);
        System.out.printf("üè∫ S√†nh s·ª©:   %,.0f VNƒê (%5.1f%%)%n", 
                         giaTriSanhSu, tongGiaTri > 0 ? (giaTriSanhSu * 100.0 / tongGiaTri) : 0);
    }
    
    private void hienThiChiTiet(HangHoa hangHoa) {
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("dd/MM/yyyy");
        
        System.out.println("üè∑Ô∏è ================================");
        System.out.printf("üìã M√£ h√†ng: %s%n", hangHoa.getMaHang());
        System.out.printf("üìù T√™n h√†ng: %s%n", hangHoa.getTenHang());
        System.out.printf("üì¶ S·ªë l∆∞·ª£ng t·ªìn: %d%n", hangHoa.getSoLuongTon());
        System.out.printf("üí∞ ƒê∆°n gi√°: %,.0f VNƒê%n", hangHoa.getDonGia());
        
        if (hangHoa instanceof ThucPham) {
            ThucPham tp = (ThucPham) hangHoa;
            System.out.println("üçé LO·∫†I: Th·ª±c ph·∫©m");
            System.out.printf("üìÖ Ng√†y s·∫£n xu·∫•t: %s%n", tp.getNgaySanXuat().format(formatter));
            System.out.printf("‚è∞ Ng√†y h·∫øt h·∫°n: %s%n", tp.getNgayHetHan().format(formatter));
            System.out.printf("üè≠ Nh√† cung c·∫•p: %s%n", tp.getNhaCungCap());
            
        } else if (hangHoa instanceof DienMay) {
            DienMay dm = (DienMay) hangHoa;
            System.out.println("‚ö° LO·∫†I: ƒêi·ªán m√°y");
            System.out.printf("üõ°Ô∏è Th·ªùi gian b·∫£o h√†nh: %d th√°ng%n", dm.getThoiGianBaoHanh());
            System.out.printf("‚ö° C√¥ng su·∫•t: %.2f KW%n", dm.getCongSuat());
            
        } else if (hangHoa instanceof SanhSu) {
            SanhSu ss = (SanhSu) hangHoa;
            System.out.println("üè∫ LO·∫†I: S√†nh s·ª©");
            System.out.printf("üè≠ Nh√† s·∫£n xu·∫•t: %s%n", ss.getNhaSanXuat());
            System.out.printf("üìÖ Ng√†y nh·∫≠p kho: %s%n", ss.getNgayNhapKho().format(formatter));
        }
        
        System.out.println("üè∑Ô∏è ================================");
    }
    
    // ================= INPUT HELPER METHODS =================
    
    private String getStringInput(String prompt) {
        System.out.print(prompt);
        String input = scanner.nextLine().trim();
        while (input.isEmpty()) {
            System.out.print("‚ùå Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng! " + prompt);
            input = scanner.nextLine().trim();
        }
        return input;
    }
    
    private int getIntInput(String prompt) {
        while (true) {
            try {
                System.out.print(prompt);
                String input = scanner.nextLine().trim();
                return Integer.parseInt(input);
            } catch (NumberFormatException e) {
                System.out.println("‚ùå Vui l√≤ng nh·∫≠p m·ªôt s·ªë nguy√™n h·ª£p l·ªá!");
            }
        }
    }
    
    private double getDoubleInput(String prompt) {
        while (true) {
            try {
                System.out.print(prompt);
                String input = scanner.nextLine().trim();
                return Double.parseDouble(input);
            } catch (NumberFormatException e) {
                System.out.println("‚ùå Vui l√≤ng nh·∫≠p m·ªôt s·ªë th·ª±c h·ª£p l·ªá!");
            }
        }
    }
    
    // ================= MAIN METHOD =================
    
    public static void main(String[] args) {
        try {
            ConsoleView console = new ConsoleView();
            console.start();
        } catch (Exception e) {
            System.err.println("‚ùå L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng: " + e.getMessage());
            e.printStackTrace();
        }
    }
}
