import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.time.LocalDate;
import java.util.List;

public class KhoGUI extends JFrame {
    private HangHoaDAO dao;
    private JTable table;
    private DefaultTableModel model;
    private JTextField txtMa, txtTen, txtSL, txtGia;
    private JComboBox<String> cboLoai;
    private JTextArea txtKQ;

    // Tr∆∞·ªùng cho Th·ª±c ph·∫©m
    private JTextField txtNgaySX, txtNgayHH, txtNhaCungCap;
    private JLabel lblNgaySX, lblNgayHH, lblNhaCungCap;

    // Tr∆∞·ªùng cho ƒêi·ªán m√°y
    private JTextField txtBaoHanh, txtCongSuat;
    private JLabel lblBaoHanh, lblCongSuat;

    // Tr∆∞·ªùng cho S√†nh s·ª©
    private JTextField txtNhaSanXuat, txtNgayNhapKho;
    private JLabel lblNhaSanXuat, lblNgayNhapKho;

    public KhoGUI() {
        try {
            dao = new HangHoaDAO();
            System.out.println("‚úÖ K·∫øt n·ªëi database OK!");
        } catch (Exception e) {
            System.err.println("‚ùå L·ªói k·∫øt n·ªëi database: " + e.getMessage());
            e.printStackTrace();
            JOptionPane.showMessageDialog(null,
                    "‚ùå L·ªói k·∫øt n·ªëi database!\n\n" +
                            "Chi ti·∫øt: " + e.getMessage() + "\n\n" +
                            "Vui l√≤ng ki·ªÉm tra:\n" +
                            "1. XAMPP ƒë√£ kh·ªüi ƒë·ªông MySQL ch∆∞a?\n" +
                            "2. Database 'QuanLyKhoHang' ƒë√£ t·ªìn t·∫°i ch∆∞a?\n" +
                            "3. File database.properties c√≥ ƒë√∫ng th√¥ng tin?\n\n" +
                            "Ch∆∞∆°ng tr√¨nh s·∫Ω tho√°t.",
                    "L·ªói Database",
                    JOptionPane.ERROR_MESSAGE);
            System.exit(1);
        }

        initUI();
        loadData();
    }

    private void initUI() {
        setTitle("üè™ Qu·∫£n L√Ω Kho");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setSize(1000, 600);
        setLocationRelativeTo(null);

        // Components
        txtMa = new JTextField(10);
        txtTen = new JTextField(15);
        txtSL = new JTextField(8);
        txtGia = new JTextField(10);
        cboLoai = new JComboBox<>(new String[] { "ThucPham", "DienMay", "SanhSu" });

        // Kh·ªüi t·∫°o c√°c tr∆∞·ªùng chi ti·∫øt
        txtNgaySX = new JTextField(10);
        txtNgayHH = new JTextField(10);
        txtNhaCungCap = new JTextField(15);
        txtBaoHanh = new JTextField(8);
        txtCongSuat = new JTextField(10);
        txtNhaSanXuat = new JTextField(15);
        txtNgayNhapKho = new JTextField(10);

        // Th√™m listener ƒë·ªÉ hi·ªán/·∫©n tr∆∞·ªùng theo lo·∫°i
        cboLoai.addActionListener(e -> updateFieldsVisibility());

        // Table
        String[] cols = { "M√£", "T√™n", "Lo·∫°i", "SL", "Gi√°", "VAT%" };
        model = new DefaultTableModel(cols, 0);
        table = new JTable(model);
        table.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        table.getSelectionModel().addListSelectionListener(e -> {
            if (!e.getValueIsAdjusting())
                selectItem();
        });

        // Result area
        txtKQ = new JTextArea(4, 30);
        txtKQ.setEditable(false);
        txtKQ.setFont(new Font(Font.MONOSPACED, Font.PLAIN, 11));

        // Layout
        setupLayout();
    }

    private void setupLayout() {
        setLayout(new BorderLayout());

        // Top - Buttons
        JPanel topPanel = new JPanel(new FlowLayout());
        topPanel.add(createBtn("üìã Xem t·∫•t c·∫£", this::xemDS));
        topPanel.add(createBtn("‚ûï Th√™m", this::them));
        topPanel.add(createBtn("‚è∞ H·∫øt h·∫°n", this::hetHan));
        topPanel.add(createBtn("üìä T·ªïng theo lo·∫°i", this::tongTheoLoai));
        topPanel.add(createBtn("üìà TB ƒëi·ªán m√°y", this::trungBinhDienMay));
        topPanel.add(createBtn("‚ùå X√≥a", this::xoa));
        topPanel.add(createBtn("‚úèÔ∏è S·ª≠a", this::sua));
        topPanel.add(createBtn("üö™ Tho√°t", this::thoat));
        add(topPanel, BorderLayout.NORTH);

        // Center - Split
        JSplitPane split = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT);

        // Left - Form
        JPanel leftPanel = new JPanel(new GridBagLayout());
        leftPanel.setBorder(BorderFactory.createTitledBorder("üìù Th√¥ng Tin"));
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(3, 3, 3, 3);
        gbc.anchor = GridBagConstraints.WEST;

        // Th√¥ng tin chung
        gbc.gridx = 0;
        gbc.gridy = 0;
        leftPanel.add(new JLabel("M√£:"), gbc);
        gbc.gridx = 1;
        leftPanel.add(txtMa, gbc);
        gbc.gridx = 0;
        gbc.gridy = 1;
        leftPanel.add(new JLabel("T√™n:"), gbc);
        gbc.gridx = 1;
        leftPanel.add(txtTen, gbc);
        gbc.gridx = 0;
        gbc.gridy = 2;
        leftPanel.add(new JLabel("Lo·∫°i:"), gbc);
        gbc.gridx = 1;
        leftPanel.add(cboLoai, gbc);
        gbc.gridx = 0;
        gbc.gridy = 3;
        leftPanel.add(new JLabel("SL:"), gbc);
        gbc.gridx = 1;
        leftPanel.add(txtSL, gbc);
        gbc.gridx = 0;
        gbc.gridy = 4;
        leftPanel.add(new JLabel("Gi√°:"), gbc);
        gbc.gridx = 1;
        leftPanel.add(txtGia, gbc);

        // Separator
        gbc.gridx = 0;
        gbc.gridy = 5;
        gbc.gridwidth = 2;
        leftPanel.add(new JSeparator(), gbc);
        gbc.gridwidth = 1;

        // Tr∆∞·ªùng cho Th·ª±c ph·∫©m
        lblNgaySX = new JLabel("üçé Ng√†y SX (dd/MM/yyyy):");
        gbc.gridx = 0;
        gbc.gridy = 6;
        leftPanel.add(lblNgaySX, gbc);
        gbc.gridx = 1;
        leftPanel.add(txtNgaySX, gbc);

        lblNgayHH = new JLabel("üçé Ng√†y HH (dd/MM/yyyy):");
        gbc.gridx = 0;
        gbc.gridy = 7;
        leftPanel.add(lblNgayHH, gbc);
        gbc.gridx = 1;
        leftPanel.add(txtNgayHH, gbc);

        lblNhaCungCap = new JLabel("üçé Nh√† cung c·∫•p:");
        gbc.gridx = 0;
        gbc.gridy = 8;
        leftPanel.add(lblNhaCungCap, gbc);
        gbc.gridx = 1;
        leftPanel.add(txtNhaCungCap, gbc);

        // Tr∆∞·ªùng cho ƒêi·ªán m√°y
        lblBaoHanh = new JLabel("‚ö° B·∫£o h√†nh (th√°ng):");
        gbc.gridx = 0;
        gbc.gridy = 9;
        leftPanel.add(lblBaoHanh, gbc);
        gbc.gridx = 1;
        leftPanel.add(txtBaoHanh, gbc);

        lblCongSuat = new JLabel("‚ö° C√¥ng su·∫•t (W):");
        gbc.gridx = 0;
        gbc.gridy = 10;
        leftPanel.add(lblCongSuat, gbc);
        gbc.gridx = 1;
        leftPanel.add(txtCongSuat, gbc);

        // Tr∆∞·ªùng cho S√†nh s·ª©
        lblNhaSanXuat = new JLabel("üè∫ Nh√† s·∫£n xu·∫•t:");
        gbc.gridx = 0;
        gbc.gridy = 11;
        leftPanel.add(lblNhaSanXuat, gbc);
        gbc.gridx = 1;
        leftPanel.add(txtNhaSanXuat, gbc);

        lblNgayNhapKho = new JLabel("üè∫ Ng√†y nh·∫≠p (dd/MM/yyyy):");
        gbc.gridx = 0;
        gbc.gridy = 12;
        leftPanel.add(lblNgayNhapKho, gbc);
        gbc.gridx = 1;
        leftPanel.add(txtNgayNhapKho, gbc);

        // Right - Table
        JPanel rightPanel = new JPanel(new BorderLayout());
        rightPanel.setBorder(BorderFactory.createTitledBorder("üìä Danh S√°ch"));
        rightPanel.add(new JScrollPane(table), BorderLayout.CENTER);

        split.setLeftComponent(leftPanel);
        split.setRightComponent(rightPanel);
        split.setDividerLocation(350);
        add(split, BorderLayout.CENTER);

        // Bottom - Result
        JPanel bottomPanel = new JPanel(new BorderLayout());
        bottomPanel.setBorder(BorderFactory.createTitledBorder("üí¨ K·∫øt Qu·∫£"));
        bottomPanel.add(new JScrollPane(txtKQ), BorderLayout.CENTER);
        add(bottomPanel, BorderLayout.SOUTH);

        // Kh·ªüi t·∫°o hi·ªÉn th·ªã ban ƒë·∫ßu
        updateFieldsVisibility();
    }

    private void updateFieldsVisibility() {
        String loai = (String) cboLoai.getSelectedItem();

        // ·∫®n t·∫•t c·∫£ tr∆∞·ªõc
        setVisibleTP(false);
        setVisibleDM(false);
        setVisibleSS(false);

        // Hi·ªán theo lo·∫°i
        if ("ThucPham".equals(loai)) {
            setVisibleTP(true);
        } else if ("DienMay".equals(loai)) {
            setVisibleDM(true);
        } else if ("SanhSu".equals(loai)) {
            setVisibleSS(true);
        }

        revalidate();
        repaint();
    }

    private void setVisibleTP(boolean visible) {
        // Set visible cho label v√† field c·ªßa th·ª±c ph·∫©m
        lblNgaySX.setVisible(visible);
        txtNgaySX.setVisible(visible);
        lblNgayHH.setVisible(visible);
        txtNgayHH.setVisible(visible);
        lblNhaCungCap.setVisible(visible);
        txtNhaCungCap.setVisible(visible);
    }

    private void setVisibleDM(boolean visible) {
        // Set visible cho label v√† field c·ªßa ƒëi·ªán m√°y
        lblBaoHanh.setVisible(visible);
        txtBaoHanh.setVisible(visible);
        lblCongSuat.setVisible(visible);
        txtCongSuat.setVisible(visible);
    }

    private void setVisibleSS(boolean visible) {
        // Set visible cho label v√† field c·ªßa s√†nh s·ª©
        lblNhaSanXuat.setVisible(visible);
        txtNhaSanXuat.setVisible(visible);
        lblNgayNhapKho.setVisible(visible);
        txtNgayNhapKho.setVisible(visible);
    }

    private JButton createBtn(String text, Runnable action) {
        JButton btn = new JButton(text);
        btn.addActionListener(e -> action.run());
        return btn;
    }

    // C√°c ch·ª©c nƒÉng ch√≠nh
    private void xemDS() {
        loadData();
        msg("üìã ƒê√£ load danh s√°ch t·∫•t c·∫£ h√†ng h√≥a trong kho");
    }

    private void them() {
        try {
            String ma = txtMa.getText().trim();
            String ten = txtTen.getText().trim();
            if (ma.isEmpty() || ten.isEmpty()) {
                msg("‚ùå Nh·∫≠p ƒë·∫ßy ƒë·ªß m√£ v√† t√™n!");
                return;
            }

            int sl = Integer.parseInt(txtSL.getText().trim());
            double gia = Double.parseDouble(txtGia.getText().trim());
            String loai = (String) cboLoai.getSelectedItem();

            boolean ok = false;
            if ("ThucPham".equals(loai)) {
                String ngaySXStr = txtNgaySX.getText().trim();
                String ngayHHStr = txtNgayHH.getText().trim();
                String nhaCungCap = txtNhaCungCap.getText().trim();

                if (ngaySXStr.isEmpty() || ngayHHStr.isEmpty() || nhaCungCap.isEmpty()) {
                    msg("‚ùå Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin th·ª±c ph·∫©m!");
                    return;
                }

                LocalDate ngaySX = parseDate(ngaySXStr);
                LocalDate ngayHH = parseDate(ngayHHStr);
                if (ngaySX == null || ngayHH == null) {
                    msg("‚ùå Ng√†y kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng dd/MM/yyyy!");
                    return;
                }

                ThucPham tp = new ThucPham(ma, ten, sl, gia, ngaySX, ngayHH, nhaCungCap);
                ok = dao.themThucPham(tp);

            } else if ("DienMay".equals(loai)) {
                String baoHanhStr = txtBaoHanh.getText().trim();
                String congSuatStr = txtCongSuat.getText().trim();

                if (baoHanhStr.isEmpty() || congSuatStr.isEmpty()) {
                    msg("‚ùå Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin ƒëi·ªán m√°y!");
                    return;
                }

                int baoHanh = Integer.parseInt(baoHanhStr);
                double congSuat = Double.parseDouble(congSuatStr);
                DienMay dm = new DienMay(ma, ten, sl, gia, baoHanh, congSuat);
                ok = dao.themDienMay(dm);

            } else {
                String nhaSanXuat = txtNhaSanXuat.getText().trim();
                String ngayNhapStr = txtNgayNhapKho.getText().trim();

                if (nhaSanXuat.isEmpty() || ngayNhapStr.isEmpty()) {
                    msg("‚ùå Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin s√†nh s·ª©!");
                    return;
                }

                LocalDate ngayNhap = parseDate(ngayNhapStr);
                if (ngayNhap == null) {
                    msg("‚ùå Ng√†y kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng dd/MM/yyyy!");
                    return;
                }

                SanhSu ss = new SanhSu(ma, ten, sl, gia, nhaSanXuat, ngayNhap);
                ok = dao.themSanhSu(ss);
            }

            if (ok) {
                msg("‚úÖ Th√™m th√†nh c√¥ng!");
                loadData();
                clear();
            } else {
                msg("‚ùå L·ªói th√™m h√†ng!");
            }
        } catch (Exception e) {
            msg("‚ùå L·ªói: " + e.getMessage());
        }
    }

    private void hetHan() {
        try {
            List<ThucPham> list = dao.timSanPhamSapHetHanTrongTuan();
            model.setRowCount(0);
            if (list.isEmpty()) {
                msg("‚úÖ Kh√¥ng c√≥ s·∫£n ph·∫©m s·∫Øp h·∫øt h·∫°n trong 1 tu·∫ßn");
            } else {
                for (ThucPham tp : list) {
                    addRow(tp);
                }
                msg("‚ö†Ô∏è C√≥ " + list.size() + " s·∫£n ph·∫©m s·∫Øp h·∫øt h·∫°n trong 1 tu·∫ßn!");
            }
        } catch (Exception e) {
            msg("‚ùå L·ªói: " + e.getMessage());
        }
    }

    private void tongTheoLoai() {
        try {
            // S·ª≠ d·ª•ng c·ª≠a s·ªï popup ƒë·ªÉ hi·ªÉn th·ªã th·ªëng k√™
            StringBuilder result = new StringBuilder();
            result.append("üìä T·ªîNG S·ªê L∆Ø·ª¢NG THEO T·ª™NG LO·∫†I H√ÄNG H√ìA\n");
            result.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n");

            List<HangHoa> danhSach = dao.layDanhSachHangHoa();

            // ƒê·∫øm theo lo·∫°i
            int tongThucPham = 0, slThucPham = 0;
            int tongDienMay = 0, slDienMay = 0;
            int tongSanhSu = 0, slSanhSu = 0;

            for (HangHoa hh : danhSach) {
                if (hh instanceof ThucPham) {
                    tongThucPham += hh.getSoLuongTon();
                    slThucPham++;
                } else if (hh instanceof DienMay) {
                    tongDienMay += hh.getSoLuongTon();
                    slDienMay++;
                } else if (hh instanceof SanhSu) {
                    tongSanhSu += hh.getSoLuongTon();
                    slSanhSu++;
                }
            }

            result.append(String.format("üçé TH·ª∞C PH·∫®M:\n"));
            result.append(String.format("   - S·ªë m·∫∑t h√†ng: %d\n", slThucPham));
            result.append(String.format("   - T·ªïng s·ªë l∆∞·ª£ng t·ªìn: %d\n\n", tongThucPham));

            result.append(String.format("‚ö° ƒêI·ªÜN M√ÅY:\n"));
            result.append(String.format("   - S·ªë m·∫∑t h√†ng: %d\n", slDienMay));
            result.append(String.format("   - T·ªïng s·ªë l∆∞·ª£ng t·ªìn: %d\n\n", tongDienMay));

            result.append(String.format("üè∫ S√ÄNH S·ª®:\n"));
            result.append(String.format("   - S·ªë m·∫∑t h√†ng: %d\n", slSanhSu));
            result.append(String.format("   - T·ªïng s·ªë l∆∞·ª£ng t·ªìn: %d\n\n", tongSanhSu));

            result.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
            result.append(String.format("üì¶ T·ªîNG C·ªòNG: %d m·∫∑t h√†ng, %d s·∫£n ph·∫©m",
                    danhSach.size(), tongThucPham + tongDienMay + tongSanhSu));

            // Hi·ªÉn th·ªã trong dialog
            JTextArea textArea = new JTextArea(result.toString());
            textArea.setFont(new Font(Font.MONOSPACED, Font.PLAIN, 12));
            textArea.setEditable(false);
            JScrollPane scrollPane = new JScrollPane(textArea);
            scrollPane.setPreferredSize(new Dimension(500, 400));

            JOptionPane.showMessageDialog(this, scrollPane,
                    "üìä Th·ªëng k√™ s·ªë l∆∞·ª£ng theo lo·∫°i", JOptionPane.INFORMATION_MESSAGE);

            msg("üìä ƒê√£ hi·ªÉn th·ªã th·ªëng k√™ s·ªë l∆∞·ª£ng theo lo·∫°i");

        } catch (Exception e) {
            msg("‚ùå L·ªói th·ªëng k√™: " + e.getMessage());
        }
    }

    private void trungBinhDienMay() {
        try {
            List<HangHoa> danhSach = dao.layDanhSachHangHoa();

            // L·ªçc ra ƒëi·ªán m√°y
            int tongSoLuong = 0;
            int soDienMay = 0;

            for (HangHoa hh : danhSach) {
                if (hh instanceof DienMay) {
                    tongSoLuong += hh.getSoLuongTon();
                    soDienMay++;
                }
            }

            StringBuilder result = new StringBuilder();
            result.append("üìà TRUNG B√åNH S·ªê L∆Ø·ª¢NG T·ªíN - H√ÄNG ƒêI·ªÜN M√ÅY\n");
            result.append("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n");

            if (soDienMay == 0) {
                result.append("‚ùå Kh√¥ng c√≥ h√†ng ƒëi·ªán m√°y n√†o trong kho!");
            } else {
                double trungBinh = (double) tongSoLuong / soDienMay;
                result.append(String.format("‚ö° S·ªë m·∫∑t h√†ng ƒëi·ªán m√°y: %d\n", soDienMay));
                result.append(String.format("üì¶ T·ªïng s·ªë l∆∞·ª£ng t·ªìn: %d\n", tongSoLuong));
                result.append(String.format("üìä Trung b√¨nh s·ªë l∆∞·ª£ng t·ªìn: %.2f\n\n", trungBinh));

                // Chi ti·∫øt t·ª´ng s·∫£n ph·∫©m
                result.append("üìã CHI TI·∫æT T·ª™NG S·∫¢N PH·∫®M:\n");
                result.append("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n");
                for (HangHoa hh : danhSach) {
                    if (hh instanceof DienMay) {
                        DienMay dm = (DienMay) hh;
                        result.append(String.format("‚Ä¢ %s (%s): %d s·∫£n ph·∫©m\n",
                                dm.getTenHang(), dm.getMaHang(), dm.getSoLuongTon()));
                    }
                }
            }

            // Hi·ªÉn th·ªã trong dialog
            JTextArea textArea = new JTextArea(result.toString());
            textArea.setFont(new Font(Font.MONOSPACED, Font.PLAIN, 12));
            textArea.setEditable(false);
            JScrollPane scrollPane = new JScrollPane(textArea);
            scrollPane.setPreferredSize(new Dimension(500, 350));

            JOptionPane.showMessageDialog(this, scrollPane,
                    "üìà Trung b√¨nh s·ªë l∆∞·ª£ng t·ªìn - ƒêi·ªán m√°y", JOptionPane.INFORMATION_MESSAGE);

            msg("üìà ƒê√£ t√≠nh trung b√¨nh s·ªë l∆∞·ª£ng t·ªìn ƒëi·ªán m√°y");

        } catch (Exception e) {
            msg("‚ùå L·ªói t√≠nh trung b√¨nh: " + e.getMessage());
        }
    }

    private void xoa() {
        String ma = txtMa.getText().trim();
        if (ma.isEmpty()) {
            msg("‚ùå Ch·ªçn h√†ng c·∫ßn x√≥a!");
            return;
        }

        int confirm = JOptionPane.showConfirmDialog(this,
                "‚ö†Ô∏è X√≥a h√†ng: " + ma + "?", "X√°c nh·∫≠n", JOptionPane.YES_NO_OPTION);
        if (confirm == JOptionPane.YES_OPTION) {
            if (dao.xoaHangHoa(ma)) {
                msg("‚úÖ X√≥a th√†nh c√¥ng!");
                loadData();
                clear();
            } else {
                msg("‚ùå L·ªói x√≥a!");
            }
        }
    }

    private void sua() {
        String ma = txtMa.getText().trim();
        if (ma.isEmpty()) {
            msg("‚ùå Ch·ªçn h√†ng c·∫ßn s·ª≠a!");
            return;
        }

        try {
            String ten = txtTen.getText().trim();
            int sl = Integer.parseInt(txtSL.getText().trim());
            double gia = Double.parseDouble(txtGia.getText().trim());

            if (dao.capNhatThongTinCoBan(ma, ten, sl, gia)) {
                msg("‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                loadData();
            } else {
                msg("‚ùå L·ªói c·∫≠p nh·∫≠t!");
            }
        } catch (Exception e) {
            msg("‚ùå L·ªói: " + e.getMessage());
        }
    }

    private void thoat() {
        int confirm = JOptionPane.showConfirmDialog(this,
                "üö™ Tho√°t ch∆∞∆°ng tr√¨nh?", "X√°c nh·∫≠n", JOptionPane.YES_NO_OPTION);
        if (confirm == JOptionPane.YES_OPTION) {
            System.exit(0);
        }
    }

    // Helper methods
    private void loadData() {
        model.setRowCount(0);
        try {
            List<HangHoa> list = dao.layDanhSachHangHoa();
            for (HangHoa hh : list) {
                addRow(hh);
            }
            msg("üìã ƒê√£ t·∫£i " + list.size() + " s·∫£n ph·∫©m");
        } catch (Exception e) {
            msg("‚ùå L·ªói t·∫£i d·ªØ li·ªáu: " + e.getMessage());
        }
    }

    private void addRow(HangHoa hh) {
        Object[] row = {
                hh.getMaHang(),
                hh.getTenHang(),
                hh.getClass().getSimpleName(),
                hh.getSoLuongTon(),
                String.format("%,.0f", hh.getDonGia()),
                String.format("%.1f%%", hh.tinhVAT() * 100)
        };
        model.addRow(row);
    }

    private void selectItem() {
        int row = table.getSelectedRow();
        if (row >= 0) {
            String maHang = (String) table.getValueAt(row, 0);
            txtMa.setText(maHang);
            txtTen.setText((String) table.getValueAt(row, 1));
            String loai = (String) table.getValueAt(row, 2);
            cboLoai.setSelectedItem(loai);
            txtSL.setText(table.getValueAt(row, 3).toString());
            String gia = table.getValueAt(row, 4).toString().replaceAll("[,.]", "");
            txtGia.setText(gia);

            // Load th√¥ng tin chi ti·∫øt t·ª´ database
            try {
                HangHoa hh = dao.timHangHoa(maHang);
                if (hh != null) {
                    // Clear t·∫•t c·∫£ field tr∆∞·ªõc
                    clearDetailFields();

                    if (hh instanceof ThucPham) {
                        ThucPham tp = (ThucPham) hh;
                        txtNgaySX.setText(
                                tp.getNgaySanXuat().format(java.time.format.DateTimeFormatter.ofPattern("dd/MM/yyyy")));
                        txtNgayHH.setText(
                                tp.getNgayHetHan().format(java.time.format.DateTimeFormatter.ofPattern("dd/MM/yyyy")));
                        txtNhaCungCap.setText(tp.getNhaCungCap());
                    } else if (hh instanceof DienMay) {
                        DienMay dm = (DienMay) hh;
                        txtBaoHanh.setText(String.valueOf(dm.getThoiGianBaoHanh()));
                        txtCongSuat.setText(String.valueOf(dm.getCongSuat()));
                    } else if (hh instanceof SanhSu) {
                        SanhSu ss = (SanhSu) hh;
                        txtNhaSanXuat.setText(ss.getNhaSanXuat());
                        txtNgayNhapKho.setText(
                                ss.getNgayNhapKho().format(java.time.format.DateTimeFormatter.ofPattern("dd/MM/yyyy")));
                    }
                }
            } catch (Exception e) {
                System.err.println("L·ªói load chi ti·∫øt: " + e.getMessage());
            }

            msg("‚úÖ ƒê√£ ch·ªçn: " + txtMa.getText());
        }
    }

    private void clearDetailFields() {
        // Clear c√°c tr∆∞·ªùng chi ti·∫øt
        txtNgaySX.setText("");
        txtNgayHH.setText("");
        txtNhaCungCap.setText("");
        txtBaoHanh.setText("");
        txtCongSuat.setText("");
        txtNhaSanXuat.setText("");
        txtNgayNhapKho.setText("");
    }

    private void msg(String text) {
        txtKQ.setText(text);
    }

    private void clear() {
        txtMa.setText("");
        txtTen.setText("");
        txtSL.setText("");
        txtGia.setText("");
        cboLoai.setSelectedIndex(0);

        // Clear c√°c tr∆∞·ªùng chi ti·∫øt
        clearDetailFields();

        updateFieldsVisibility();
    }

    private LocalDate parseDate(String dateStr) {
        try {
            String[] parts = dateStr.split("/");
            if (parts.length != 3)
                return null;
            int day = Integer.parseInt(parts[0]);
            int month = Integer.parseInt(parts[1]);
            int year = Integer.parseInt(parts[2]);
            return LocalDate.of(year, month, day);
        } catch (Exception e) {
            return null;
        }
    }

    public static void main(String[] args) {
        System.out.println("üñºÔ∏è ƒêang kh·ªüi ƒë·ªông GUI Mode...");
        System.out.println("üîç Ki·ªÉm tra k·∫øt n·ªëi database...");

        SwingUtilities.invokeLater(() -> {
            try {
                JFrame frame = new KhoGUI();
                frame.setVisible(true);
                System.out.println("‚úÖ GUI ƒë√£ kh·ªüi ƒë·ªông th√†nh c√¥ng!");
            } catch (Exception e) {
                System.err.println("‚ùå L·ªói kh·ªüi ƒë·ªông GUI: " + e.getMessage());
                e.printStackTrace();

                // Hi·ªÉn th·ªã dialog l·ªói
                JOptionPane.showMessageDialog(null,
                        "‚ùå Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông GUI!\n\n" +
                                "L·ªói: " + e.getMessage() + "\n\n" +
                                "Vui l√≤ng th·ª≠ ch·∫°y Console Mode.",
                        "L·ªói GUI",
                        JOptionPane.ERROR_MESSAGE);

                System.exit(1);
            }
        });
    }
}
